<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mapa de Incidentes DGT - Control de Estilos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    body { margin: 0; padding: 0; }
    #map { height: 100vh; width: 100vw; }
    .incident-icon { display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
  const geojsonURL = "https://raw.githubusercontent.com/WireNext/TESTIncidenciasCarreteras/main/traffic_data.geojson";

  // ==========================================
  // CONFIGURACIÓN DE COLORES PERSONALIZADOS
  // ==========================================
  
  // Colores para las LÍNEAS (Tramos de carretera)
  const COLORES_LINEA = {
    critico: "#000000",   // NEGRO para carretera cortada
    medio: "#ff8c00",     // NARANJA OSCURO para retenciones/obras
    fluido: "#007bff",    // AZUL para tráfico normal
    defecto: "#007bff"
  };

  // Colores para las GOTAS (Iconos circulares)
  const COLORES_GOTA = {
    critico: "#ff0000",   // ROJO para el icono de aviso grave
    medio: "#ffcc00",     // AMARILLO/NARANJA para el icono medio
    fluido: "#4caf50",    // VERDE CLARO para el icono fluido
    defecto: "#9e9e9e"
  };

  // Función para clasificar el impacto
  function getImpactLevel(description) {
    const desc = description.toLowerCase();
    if (desc.includes("imposible") || desc.includes("corte") || desc.includes("cerrada") || desc.includes("cortada")) {
      return "critico";
    }
    if (desc.includes("sin retención") || desc.includes("fluido")) {
      return "fluido";
    }
      if (desc.includes("cadenas")) {
      return "medio";
    }
    return "medio";
  }

  function getIconName(description) {
    const desc = description.toLowerCase();
    if (desc.includes("obra")) return "construction";
    if (desc.includes("nieve")) return "ac_unit";
    if (desc.includes("averiado")) return "car_crash";
    if (desc.includes("fuego")) return "local_fire_department";
    if (desc.includes("inunciación")) return "flood";
    if (desc.includes("objeto")) return "remove_road";
    if (desc.includes("piedras")) return "landslide";
    if (desc.includes("lluvia")) return "rainy";
    if (desc.includes("niebla")) return "foggy";
    if (desc.includes("parado")) return "auto_towing";

    return "warning";
  }

  const map = L.map('map').setView([40.4, -3.7], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);

  const markers = L.markerClusterGroup({ disableClusteringAtZoom: 13 });

  fetch(geojsonURL)
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        // --- ESTILO DE LAS LÍNEAS ---
        style: function(feature) {
          if (feature.geometry.type === 'LineString') {
            const nivel = getImpactLevel(feature.properties.description);
            return {
              color: COLORES_LINEA[nivel], // Usará NEGRO si es crítico
              weight: 8,
              opacity: 0.8,
              lineJoin: 'round'
            };
          }
        },
        // --- ESTILO DE LAS GOTAS ---
        pointToLayer: function(feature, latlng) {
          const desc = feature.properties.description;
          const nivel = getImpactLevel(desc);
          const bgColor = COLORES_GOTA[nivel]; // Usará ROJO si es crítico
          const icon = getIconName(desc);

          const html = `
            <div style="background-color: ${bgColor}; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.5);">
              <span class="material-icons" style="font-size: 16px; color: white;">${icon}</span>
            </div>`;

          return L.marker(latlng, {
            icon: L.divIcon({ html: html, className: 'incident-icon', iconSize: [28, 28], iconAnchor: [14, 14] })
          });
        },
        onEachFeature: function(feature, layer) {
          layer.bindPopup(feature.properties.description);
        }
      }).addTo(markers);
      
      map.addLayer(markers);
    });
</script>

</body>
</html>